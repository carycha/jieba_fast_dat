# jieba_fast_dat 架構文件

## 1. 簡介
本文件概述了 `jieba_fast_dat` 專案的架構決策，旨在透過將其記憶體中的 Trie 替換為雙陣列 Trie (DAT) 並利用記憶體映射檔案 (mmap) 來實現高效的詞典載入。此變更旨在顯著減少記憶體佔用並加速詞典初始化。

## 2. 目標
*   **減少 RAM 使用量：** 大幅降低詞典載入期間的記憶體消耗。
*   **提升載入速度：** 顯著縮短載入詞典所需的時間。
*   **保持 API 相容性：** 保留現有的文本分詞 API（不包括動態詞語添加功能）。
*   **確保準確性：** 維持目前的分詞準確性和行為。
*   **自動快取管理：** 在使用者詞典變更時實作自動 DAT 快取重建。

## 3. 高階架構

核心思想是從動態的記憶體 Trie 結構轉變為預先建置、可記憶體映射的 DAT。

```mermaid
graph TD
    A[使用者詞典檔案] --> B[DAT 建構器 (C/C++)]
    B --> C[DAT 快取檔案 (.dat)]
    C --> D[mmap 載入器 (C/C++)]
    D --> E[Python 包裝器 (Cython/CFFI)]
    E --> F[jieba_fast_dat Python API]
    F --> G[文本分詞邏輯]
```

**組件：**
*   **使用者詞典檔案：** 現有的詞典檔案（例如 `dict.txt`、`userdict.txt`）。
*   **DAT 建構器 (C/C++)：** 一個新的工具，負責讀取詞典檔案並建構 DAT 結構。然後將此 DAT 序列化為二進位快取檔案。
*   **DAT 快取檔案 (.dat)：** 包含序列化雙陣列 Trie 的二進位檔案。此檔案將設計用於直接記憶體映射。
*   **mmap 載入器 (C/C++)：** 一個 C/C++ 組件，使用 `mmap` 將 DAT 快取檔案直接載入到記憶體的虛擬位址空間中，提供快速、零複製的 DAT 結構存取。
*   **Python 包裝器 (Cython/CFFI)：** 介面層，將 C/C++ DAT 功能暴露給 Python。這將處理 Python 分詞邏輯與底層 C/C++ DAT 之間的互動。
*   **jieba_fast_dat Python API：** 現有的文本分詞公共 API。此層將被修改以利用新的基於 DAT 的後端。
*   **文本分詞邏輯：** 執行詞語分詞的核心邏輯，現在查詢 DAT 以獲取詞語存在和屬性。

## 4. 詳細設計

### 4.1 雙陣列 Trie (DAT) 實作
*   **語言：** C/C++，以實現最大性能和記憶體控制。
*   **結構：** DAT 將儲存詞典中的詞語及其相關頻率/屬性。
*   **序列化：** DAT 建構器將 DAT 序列化為緊湊的二進位格式，適用於 `mmap`。此格式應包含元資料（例如，詞典版本、校驗和）以進行完整性檢查。

### 4.2 mmap 載入機制
*   **語言：** C/C++
*   **機制：** 使用 `mmap` 將 DAT 快取檔案直接映射到進程的虛擬位址空間。這避免了傳統檔案 I/O 開銷，並允許作業系統有效地管理記憶體分頁。
*   **錯誤處理：** 對於 `mmap` 失敗（例如，找不到檔案、權限問題）進行穩健的錯誤處理。

### 4.3 Python-C 整合
*   **選擇：** 將使用 Cython 或 CFFI 將 C/C++ DAT 和 `mmap` 載入器綁定到 Python。
    *   **Cython：** 提供強型別和直接 C 級別存取，可能帶來更好的性能並更容易與現有 C 程式碼整合。需要編譯步驟。
    *   **CFFI：** 提供一種從 Python 呼叫 C 函數的方法，而無需編寫 C 擴展，對於較小的介面可能更簡單。
*   **API 暴露：** Python 包裝器將暴露以下功能：
    *   初始化 DAT（從 mmap 載入）。
    *   查詢 DAT 以獲取詞語存在和屬性。
    *   釋放 mmap 資源。

### 4.4 詞典管理和快取重建
*   **使用者詞典監控：** 系統將監控使用者詞典檔案的修改時間戳或雜湊值。
*   **快取失效：** 如果檢測到變更，現有的 DAT 快取檔案將被標記為無效。
*   **重建觸發：** 在 `jieba_fast_dat` 下次初始化時（例如，當模組被導入或呼叫 `load_userdict` 時），如果快取無效或缺失，將呼叫 DAT 建構器以重建 DAT 快取檔案。
*   **移除動態詞語添加：** `add_word` 和 `InsertUserWord` 等動態添加使用者詞的功能將從公共 API 中移除。將指示使用者修改其詞典檔案並觸發重新初始化以使變更生效。

### 4.5 與現有分詞邏輯整合
*   現有的 Python 分詞演算法將被修改為使用新的 Python 包裝的 DAT 查詢函數，而不是舊的 Trie。
*   核心分詞邏輯應保持基本不變，只會替換底層的詞典查詢機制。

## 5. 資料結構
*   **雙陣列 Trie (DAT)：**
    *   `base` 陣列：儲存轉換的基本索引。
    *   `check` 陣列：儲存驗證的檢查索引。
    *   `value` 陣列（可選）：儲存終端節點的相關值（例如，頻率、詞性標籤）。
*   **詞典條目：** 來源詞典中的每個條目都將由 DAT 建構器處理以填充 DAT。

## 6. 建置和部署考量
*   **建置過程：** DAT 建構器將整合到 `setup.py` 或等效的建置腳本中。它將在套件安裝期間或專用的建置步驟中觸發，以生成 `.dat` 快取檔案。
*   **快取檔案位置：** `.dat` 快取檔案將儲存在套件結構中定義明確、可存取的位置，或使用者可配置的路徑。
*   **跨平台相容性：** 確保 DAT 建構器和 `mmap` 載入在目標作業系統（Linux、macOS、Windows）上相容。

## 7. 測試策略
*   **單元測試：**
    *   DAT 建構器：驗證從各種詞典輸入正確建構 DAT。
    *   DAT 查詢：測試詞語查詢、前綴搜尋和相關值檢索。
    *   mmap 載入器：測試檔案映射、錯誤處理和資料完整性。
    *   Python 包裝器：測試 Python 和 C/C++ 之間的正確綁定和函數呼叫。
*   **整合測試：**
    *   使用新的 DAT 後端進行端到端分詞測試。
    *   驗證 API 相容性（不包括已移除的功能）。
    *   測試快取重建機制。
*   **性能測試：**
    *   測量變更前後的詞典載入時間和 RAM 使用量。
    *   基準測試分詞速度。
*   **準確性測試：**
    *   將分詞結果與舊實作進行比較，以確保準確性沒有下降。

## 8. 風險和緩解
*   **DAT 實作複雜性：**
    *   **緩解：** 使用成熟的 DAT 演算法，並可能參考現有的開源 DAT 實作。將實作分解為更小、可測試的模組。
*   **Python-C 性能瓶頸：**
    *   **緩解：** 精心設計 Python-C 介面，以最大程度地減少資料複製和函數呼叫開銷。分析關鍵路徑以識別和優化瓶頸。
*   **快取重建可靠性：**
    *   **緩解：** 實作穩健的檔案監控和雜湊機制。徹底測試邊緣情況（例如，並發檔案存取、檔案損壞）。
*   **向後不相容性（動態詞語添加）：**
    *   **緩解：** 在發布說明中明確記錄此功能的移除，並為使用者提供遷移指南。

## 9. 未來考量
*   **增量 DAT 更新：** 探索增量 DAT 更新的可能性，以處理非常大的詞典，儘管這會增加顯著的複雜性。
*   **分散式詞典：** 對於極大規模的應用程式，考慮分散式詞典解決方案。（超出本次增強功能的範圍）。
