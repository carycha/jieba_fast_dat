# `jieba_fast_dat` 效能優化與功能增強專案知識庫

**最後更新時間:** 2025-10-13

### A. 專案核心目標 (Goal)

1.  **核心效能優化:** 解決 `jieba_fast_dat` 首次啟動時的效能瓶頸，實現近乎瞬時的啟動速度與最低的記憶體佔用。
2.  **功能增強:** 仿效 `cppjieba-py-dat` 的設計，實現了一個動態、持久化且能自動失效的 DAT 快取機制，以優雅地支援使用者自訂詞典。

### B. 環境與執行者 (Context)

*   **執行者:** 所有程式碼與指令由使用者在本地端執行。
*   **開發環境:** Docker Swarm (Container 內)。
*   **核心技術棧:** Python 3.x, C++, `darts-clone`, `uv` (虛擬環境管理與套件安裝), `pybind11`, `pytest` (測試框架)。
*   **命名規範:**
    *   **安裝名稱 (Package Name):** `jieba_fast_dat`
    *   **導入名稱 (Import Name):** `jieba_fast_dat`

### F. 專案核心知識與最佳實踐 (Core Knowledge & Best Practices)

*   **Double-Array Trie (DAT) 優勢:**
    *   **記憶體效率:** 相較於傳統 Trie，DAT 使用雙陣列結構 (BASE 和 CHECK) 大幅降低記憶體佔用，尤其適用於大型詞典，可將數百 MB 的詞典壓縮至數 MB。
    *   **緊湊性:** DAT 結構緊湊，適合記憶體受限的環境。
*   **Memory-Mapped Files (mmap) 優勢:**
    *   **快速載入:** 允許將磁碟檔案直接映射到記憶體，實現預建 DAT 快取檔案的近乎瞬時初始化，因為資料是按需載入而非一次性載入。
    *   **降低 RAM 使用:** 將檔案直接映射到虛擬位址空間，減少實際物理 RAM 消耗。
    *   **多行程共享:** 支援多個行程共享相同的詞典資料，進一步優化多行程環境下的記憶體使用。
*   **DAT 與 mmap 結合效益:** `cppjieba-py-dat` 透過結合 DAT 的記憶體效率和 `mmap` 的快速載入及記憶體共享能力，提供了高效能、低記憶體的中文分詞解決方案。
*   **限制:** 採用 DAT 快取機制通常不支援執行時動態詞語新增；詞典更新通常需要重建 DAT 快取。
*   **依賴管理與虛擬環境:** 專案已採用 `uv` 進行虛擬環境管理與套件安裝，並透過 `requirements.txt` 集中管理依賴。`requirements.txt` 中包含了 `setuptools`, `wheel`, `swig` (暫時保留，待後續遷移至 `pybind11` 後移除) 及 `pytest`。開發環境指南 (`README.md`) 已更新以反映 `uv` 的使用方式和最新的環境要求。
*   **測試流程:** 已建立自動化測試檔案 (`test/test_segmentation_pos.py`)，用於驗證切詞與詞性標注功能。該測試可透過 `uv run pytest -s test/test_segmentation_pos.py` 指令執行，並透過 `-s` 參數顯示詳細輸出，以便肉眼確認切詞與詞性標注結果的正確性，確保每次修改後功能正常。

### D. 協作日誌與決策總結 (Key Decisions & Logs)

*   **問題:** 專案目前支援 Python 2 和 Windows，增加了維護複雜性並限制了對現代 Python 特性和工具的利用。
*   **決策:** 移除對 Python 2 和 Windows 的支援，專注於 Python 3 (Linux/macOS) 環境，以簡化開發、提高效率並利用最新技術。
*   **知識/教訓:** 移除舊版支援有助於專案的現代化和長期可維護性。
*   **問題:** 專案的套件名稱和導入名稱與實際的專案目錄結構 `jieba_fast_dat` 不一致，可能導致混淆。
*   **決策:** 將套件名稱和導入名稱統一改為 `jieba_fast_dat`，以提高專案的一致性和可維護性。
*   **知識/教訓:** 保持專案命名的一致性對於長期維護和新開發者的上手至關重要。
*   **問題:** 需要一個高效且現代化的工具來管理 Python 套件安裝和虛擬環境。
*   **決策:** 採用 `uv` 作為套件管理和虛擬環境建立工具，以其高性能和簡潔性提升開發體驗。
*   **知識/教訓:** `uv` 能夠顯著加速依賴解析和安裝過程，並提供輕量級的虛擬環境管理。
*   **問題:** 專案目前使用 SWIG 進行 C++ 與 Python 的綁定，但 `pybind11` 提供了更現代、更 Pythonic 的綁定方式，且通常具有更好的性能和更低的學習曲線。
*   **決策:** 將 C++ 綁定技術從 SWIG 遷移到 `pybind11`，以提升開發效率、程式碼品質和維護性。
*   **知識/教訓:** `pybind11` 是一個輕量級的僅標頭庫，用於在 C++11 和 Python 之間創建互操作性，它比 SWIG 更容易使用，並生成更慣用的 Python 程式碼。
*   **問題:** 專案的測試分散且可能沒有統一的測試框架，導致測試管理和執行效率低下。
*   **決策:** 統一使用 `pytest` 作為專案的測試框架，並確保 `test/` 目錄下的所有測試都能被 `pytest` 發現和執行。
*   **知識/教訓:** `pytest` 提供了豐富的功能、易於使用的斷言和插件生態系統，有助於提高測試效率和程式碼品質。

### E. 進度管理與待辦事項 (Progress & To-Do)

*   **DONE:**
    *   移除所有 Python 2 相關的程式碼和配置。
    *   移除所有 Windows 相關的程式碼和配置。
    *   更新 `setup.py` 以反映移除 Python 2 和 Windows 支援。
    *   更新 `MANIFEST.in` 以移除任何 Python 2 或 Windows 相關的檔案包含規則。
    *   檢查並修改 `jieba_fast/_compat.py` 中任何 Python 2 相容性程式碼。
    *   修改 `setup.py` 中的套件名稱、`packages` 和 `package_dir` 為 `jieba_fast_dat`。
    *   將專案根目錄下的 `jieba_fast/` 目錄重新命名為 `jieba_fast_dat/`。
    *   創建 `requirements.txt` 並包含 `setuptools`, `wheel`, `swig`。
    *   創建 `uv` 虛擬環境並安裝依賴。
    *   建制uv虛擬環境後，就先測試是否能在虛擬環境中正確運作。
    *   建立測試檔案，測試切詞與詞性標注是否有正確運作(是否有切詞, 是否能標注詞性(不能全部是x)), 以此每次修改後就執行測試一下是否功能壞掉了。
    *   更新開發和測試環境的設置指南，以包含 `uv` 的使用說明。
*   **TODO:**
    *   DONE: 檢查 `MANIFEST.in` 是否需要更新 `jieba_fast/` 為 `jieba_fast_dat/`。
    *   將專案的套件安裝和虛擬環境管理流程遷移到 `uv`。
    *   將 C++ 綁定從 SWIG 遷移到 `pybind11`。
    *   更新 `setup.py` 中的擴展模組配置，以使用 `pybind11`。
    *   移除所有 SWIG 相關的檔案（例如 `.i` 和 `_wrap.c` 檔案）。
    *   將 `test/` 目錄下的所有測試遷移到 `pytest` 框架。
    *   確保所有測試都能被 `pytest` 發現並正確執行。
    *   更新測試執行指令和相關文件，以反映 `pytest` 的使用。